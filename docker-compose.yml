version: '3.8'

services:
  # KPI Server Service - Must start first for ZMQ communication
  kpi-server:
    build:
      context: .
      dockerfile: Dockerfile.kpi
    image: kpi-server:latest
    container_name: kpi-server
    hostname: kpi-server
    ports:
      # Expose ZMQ port for communication
      - "5555:5555"
    volumes:
      # Mount your HDF data files
      - ./hdf_DB:/app/hdf_DB
      # Mount output directory for generated HTML reports
      - ./html:/app/html
      # Mount logs directory
      - ./logs:/app/logs
    environment:
      - PYTHONUNBUFFERED=1
      - KPI_ZMQ_PORT=5555
    # Run KPI server in ZMQ mode
    command: python -m KPI.kpi_server zmq 5555
    networks:
      - kpi-network
    healthcheck:
      test: ["CMD", "python", "-c", "import zmq; c=zmq.Context(); s=c.socket(zmq.REQ); s.connect('tcp://127.0.0.1:5555'); s.close()"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  # Interactive Plot Service - Connects to KPI server via ZMQ
  interactiveplot:
    build:
      context: .
      dockerfile: Dockerfile.interactiveplot
    image: interactiveplot:latest
    container_name: interactiveplot
    depends_on:
      kpi-server:
        condition: service_healthy
    volumes:
      # Mount your HDF data files
      - ./hdf_DB:/app/data
      # Mount output directory for generated HTML
      - ./html:/app/html
      # Mount plots directory
      - ./plots:/app/plots
    environment:
      - PYTHONUNBUFFERED=1
      # KPI server connection settings for ZMQ/protobuf
      - KPI_SERVER_HOST=kpi-server
      - KPI_SERVER_PORT=5555
    networks:
      - kpi-network
    # Override command as needed
    # command: python ResimHTMLReport.py --input /app/data/input.h5 --output /app/html

  # KPI JSON Mode Service (batch processing without ZMQ)
  kpi-json-processor:
    build:
      context: .
      dockerfile: Dockerfile.kpi
    image: kpi-server:latest
    container_name: kpi-json-processor
    volumes:
      - ./hdf_DB:/app/hdf_DB
      - ./html:/app/html
      - ./logs:/app/logs
      - ./KPIPlot.json:/app/KPIPlot.json:ro
    environment:
      - PYTHONUNBUFFERED=1
    command: python -m KPI.kpi_server KPIPlot.json /app/html
    profiles:
      - batch  # Only run when explicitly requested

  # KPI Dummy HDF Generator (for testing)
  kpi-generator:
    build:
      context: .
      dockerfile: Dockerfile.kpi
    image: kpi-server:latest
    container_name: kpi-generator
    volumes:
      # Mount output directory for generated HDF files
      - ./hdf_DB:/app/hdf_DB
    environment:
      - PYTHONUNBUFFERED=1
    command: python -m KPI.a_persistence_layer.kpi_dummy_hdf_generator
    profiles:
      - tools  # Only run when explicitly requested
    networks:
      - kpi-network

networks:
  kpi-network:
    name: kpi-zmq-network
    driver: bridge

digraph KPI_Data_Flow {
    rankdir=TB;
    node [shape=box, style=filled, fontname="Arial"];
    edge [fontname="Arial"];
    
    // Define color scheme
    subgraph cluster_server {
        label="KPI Server Layer";
        style=filled;
        color=lightblue;
        
        kpi_server [label="kpi_server.py\n(ZMQ Server)", fillcolor=lightcyan];
        parse_for_kpi [label="parse_for_kpi()\nFunction", fillcolor=lightcyan];
    }
    
    subgraph cluster_wrapper {
        label="HDF Wrapper Layer";
        style=filled;
        color=lightgreen;
        
        hdf_wrapper [label="hdf_wrapper.py\n(KPIHDFWrapper)", fillcolor=lightgreen];
        config [label="KPIProcessingConfig", fillcolor=palegreen];
    }
    
    subgraph cluster_parser {
        label="Parser Layer";
        style=filled;
        color=lightyellow;
        
        kpi_hdf_parser [label="kpi_hdf_parser.py\n(KPIHDFParser)", fillcolor=lightyellow];
        hdf_files [label="HDF5 Files\n(Input/Output)", fillcolor=wheat, shape=cylinder];
    }
    
    subgraph cluster_storage {
        label="Data Storage Layer";
        style=filled;
        color=lightpink;
        
        data_model [label="kpi_data_model_storage.py\n(KPI_DataModelStorage)", fillcolor=lightpink];
        stream_input [label="Stream Input Model", fillcolor=mistyrose];
        stream_output [label="Stream Output Model", fillcolor=mistyrose];
    }
    
    subgraph cluster_business {
        label="Business Logic Layer";
        style=filled;
        color=lightcoral;
        
        kpi_factory [label="kpi_factory.py\n(KpiDataModel)", fillcolor=lightcoral];
        alignment_kpi [label="Alignment KPI", fillcolor=salmon];
        detection_kpi [label="Detection KPI", fillcolor=salmon];
        tracker_kpi [label="Tracker KPI", fillcolor=salmon];
    }
    
    subgraph cluster_output {
        label="Output Layer";
        style=filled;
        color=lavender;
        
        html_report [label="HTML Report\nGeneration", fillcolor=lavender];
    }
    
    // Data flow connections
    kpi_server -> parse_for_kpi [label="sensor_id, paths"];
    parse_for_kpi -> config [label="create config"];
    config -> hdf_wrapper [label="initialize"];
    hdf_wrapper -> hdf_files [label="open HDF5 files"];
    hdf_files -> kpi_hdf_parser [label="HDF5 groups"];
    kpi_hdf_parser -> data_model [label="parsed data"];
    data_model -> stream_input;
    data_model -> stream_output;
    stream_input -> kpi_factory [label="input data"];
    stream_output -> kpi_factory [label="output data"];
    kpi_factory -> alignment_kpi;
    kpi_factory -> detection_kpi;
    kpi_factory -> tracker_kpi;
    alignment_kpi -> html_report;
    detection_kpi -> html_report;
    tracker_kpi -> html_report;
    html_report -> kpi_server [label="HTML path"];
}

# Singularity/Apptainer definition file for KPI Tool
# Build with: apptainer build --fakeroot kpi.simg Singularity_KPI.def
#
# Resource Requirements:
#   - Memory: 32 GB
#   - CPUs: 7-10
#   - Partition: plcyf-com
#
# Usage Modes:
#   1. JSON Batch Mode:
#      srun --partition=plcyf-com --mem=32G --cpus-per-task=8 \
#          singularity run kpi.simg json KPIPlot.json [html_dir]
#
#   2. HDF Pair Mode:
#      srun --partition=plcyf-com --mem=32G --cpus-per-task=8 \
#          singularity run kpi.simg hdf input.h5 output.h5 [html_dir]
#
#   3. ZMQ Server Mode:
#      singularity run kpi.simg zmq [port]

Bootstrap: docker
From: docker.io/python:3.10-slim

%labels
    Name KPI
    Version 1.0
    Author ouymc2
    Description KPI Analysis Tool - KPI HTML generation with ZMQ and batch modes

%environment
    export PYTHONUNBUFFERED=1
    export PATH=/opt/venv/bin:$PATH
    export PYTHONPATH=/app/tools:$PYTHONPATH

%post
    # Install system dependencies
    apt-get update && apt-get install -y --no-install-recommends \
        build-essential \
        libpq-dev \
        git \
        curl \
        ca-certificates \
        && rm -rf /var/lib/apt/lists/*

    # Create virtual environment
    python -m venv /opt/venv
    . /opt/venv/bin/activate
    pip install --upgrade pip setuptools wheel

    # Install Python dependencies (minimal, no version pins for speed)
    pip install --no-cache-dir numpy pandas h5py plotly lxml pyzmq

    # Create required directories
    mkdir -p /app/tools /app/output /app/html_db /app/simg/html_db
    chmod -R 755 /app

%files
    # Copy KPI tool and dependencies (paths from project root)
    tools/KPI/a_persistence_layer /app/tools/KPI/a_persistence_layer
    tools/KPI/b_data_storage /app/tools/KPI/b_data_storage
    tools/KPI/c_business_layer /app/tools/KPI/c_business_layer
    tools/KPI/d_presentation_layer /app/tools/KPI/d_presentation_layer
    tools/KPI/kpi_server.py /app/tools/KPI/kpi_server.py
    tools/KPI/__init__.py /app/tools/KPI/__init__.py
    # Copy InteractivePlot dependencies needed by KPI
    tools/InteractivePlot/b_persistence_layer /app/tools/InteractivePlot/b_persistence_layer
    tools/InteractivePlot/d_business_layer /app/tools/InteractivePlot/d_business_layer
    tools/InteractivePlot/kpi_client /app/tools/InteractivePlot/kpi_client

%runscript
    # Activate virtual environment
    . /opt/venv/bin/activate
    
    # Parse mode argument
    MODE="${1:-help}"
    shift 2>/dev/null || true
    
    case "$MODE" in
        json)
            # JSON Batch Mode: kpi.simg json KPIPlot.json [html_dir]
            if [ -z "$1" ]; then
                echo "Error: JSON file path required"
                echo "Usage: singularity run kpi.simg json <KPIPlot.json> [html_dir]"
                exit 1
            fi
            JSON_FILE="$1"
            HTML_DIR="${2:-$(dirname $JSON_FILE)/html_db}"
            
            echo "=== KPI Tool - JSON Batch Mode ==="
            echo "JSON File: $JSON_FILE"
            echo "HTML Output: $HTML_DIR"
            echo "Started at: $(date)"
            echo ""
            
            mkdir -p "$HTML_DIR"
            cd /app/tools
            exec python -m KPI.kpi_server "$JSON_FILE" "$HTML_DIR"
            ;;
            
        hdf)
            # HDF Pair Mode: kpi.simg hdf input.h5 output.h5 [html_dir]
            if [ -z "$1" ] || [ -z "$2" ]; then
                echo "Error: Both input and output HDF files required"
                echo "Usage: singularity run kpi.simg hdf <input.h5> <output.h5> [html_dir]"
                exit 1
            fi
            INPUT_HDF="$1"
            OUTPUT_HDF="$2"
            HTML_DIR="${3:-$(dirname $OUTPUT_HDF)/html_db}"
            
            echo "=== KPI Tool - HDF Pair Mode ==="
            echo "Input HDF: $INPUT_HDF"
            echo "Output HDF: $OUTPUT_HDF"
            echo "HTML Output: $HTML_DIR"
            echo "Started at: $(date)"
            echo ""
            
            mkdir -p "$HTML_DIR"
            cd /app/tools
            exec python -m KPI.kpi_server "$INPUT_HDF" "$OUTPUT_HDF" "$HTML_DIR"
            ;;
            
        zmq)
            # ZMQ Server Mode: kpi.simg zmq [port]
            PORT="${1:-5555}"
            
            echo "=== KPI Tool - ZMQ Server Mode ==="
            echo "Port: $PORT"
            echo "Started at: $(date)"
            echo ""
            
            cd /app/tools
            exec python -m KPI.kpi_server zmq "$PORT"
            ;;
            
        help|--help|-h|*)
            echo "KPI Tool - Singularity Container"
            echo ""
            echo "Usage:"
            echo "  singularity run kpi.simg <mode> [arguments]"
            echo ""
            echo "Modes:"
            echo "  json <KPIPlot.json> [html_dir]"
            echo "      Process HDF pairs defined in JSON file"
            echo ""
            echo "  hdf <input.h5> <output.h5> [html_dir]"
            echo "      Process a single HDF pair"
            echo ""
            echo "  zmq [port]"
            echo "      Start ZMQ server (default port: 5555)"
            echo ""
            echo "Examples:"
            echo "  # JSON mode with srun"
            echo "  srun --partition=plcyf-com --mem=32G --cpus-per-task=8 \\"
            echo "      singularity run kpi.simg json KPIPlot.json /output/html_db"
            echo ""
            echo "  # HDF mode with srun"
            echo "  srun --partition=plcyf-com --mem=32G --cpus-per-task=8 \\"
            echo "      singularity run kpi.simg hdf input.h5 output.h5 /output/html_db"
            exit 0
            ;;
    esac

%test
    . /opt/venv/bin/activate
    python -c "import numpy; import pandas; import h5py; import plotly; import zmq; print('All dependencies OK')"

%help
    KPI Analysis Tool - Singularity Container
    
    Generates KPI HTML reports from HDF sensor data files.
    Supports JSON batch mode, HDF pair mode, and ZMQ server mode.
    
    Resource Requirements:
      - Memory: 32 GB
      - CPUs: 7-10 cores
      - Recommended Partition: plcyf-com
    
    Usage with srun:
      # JSON Batch Mode (recommended for multiple files)
      srun --partition=plcyf-com --mem=32G --cpus-per-task=8 \
          singularity run kpi.simg json KPIPlot.json /output/html_db
      
      # HDF Pair Mode (for single file)
      srun --partition=plcyf-com --mem=32G --cpus-per-task=8 \
          singularity run kpi.simg hdf input.h5 output.h5 /output/html_db
    
    JSON File Format (KPIPlot.json):
      [
        {
          "input_path": "/path/to/input.h5",
          "output_path": "/path/to/output.h5"
        }
      ]
    
    Environment Variables:
      HTML_DIR - Override default HTML output directory

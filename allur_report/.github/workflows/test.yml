name: Tests with Allure Report

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.21'
        
    - name: Install Allure
      run: |
        wget -qO- https://repo.maven.apache.org/maven2/io/qameta/allure/allure-commandline/2.24.0/allure-commandline-2.24.0.tgz | tar -xz -C /opt/
        sudo ln -s /opt/allure-2.24.0/bin/allure /usr/bin/allure
        
    - name: Download dependencies
      run: go mod tidy
      
    - name: Run tests and generate Allure results
      run: |
        go test ./tests/... -v -json | go run main.go -results=results -output=reports -debug=true
        
    - name: Generate Allure report
      run: allure generate results/ -o reports/ --clean
      
    - name: Upload Allure report as artifact
      uses: actions/upload-artifact@v3
      with:
        name: allure-report
        path: reports/
        retention-days: 30
        
    - name: Upload Allure results as artifact
      uses: actions/upload-artifact@v3
      with:
        name: allure-results
        path: results/
        retention-days: 30
        
    - name: Publish Allure Report
      uses: simple-elf/allure-report-action@master
      if: always()
      with:
        allure_results: results/
        allure_report: reports/
        allure_version: 2.24.0
        
    - name: Comment PR with report link
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          // Check if report was generated
          const reportPath = 'reports';
          if (fs.existsSync(reportPath)) {
            const files = fs.readdirSync(reportPath);
            if (files.length > 0) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: `## ðŸŽ¯ Allure Report Generated
                
                Test execution completed successfully!
                
                ðŸ“Š **Report Details:**
                - Results: \`results/\`
                - Report: \`reports/\`
                
                ðŸ”— **View Report:** Check the artifacts above to download the Allure report.
                
                ---
                *Generated by Allure Report POC in Go*`
              });
            }
          } 
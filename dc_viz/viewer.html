<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Log Viewer</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    .page {
      padding: 12px 16px 16px 16px;
    }
    .toolbar {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 12px;
    }
    .toolbar label {
      font-weight: bold;
    }
    .toolbar select {
      padding: 4px 6px;
    }
    .layout {
      display: grid;
      grid-template-columns: 1fr 1fr;
      grid-template-rows: 1fr 1fr;
      grid-gap: 10px;
      height: calc(100vh - 70px);
    }
    .box {
      border-radius: 4px;
      padding: 8px;
      box-sizing: border-box;
      background: #f5f5f5;
      overflow: hidden;
    }
    .video-box {
      border: 2px solid #ff7f50;
      display: flex;
      flex-direction: column;
    }
    .video-box video {
      width: 100%;
      height: 100%;
      max-height: 100%;
      background: #000;
    }
    .video-info {
      margin-top: 4px;
      font-size: 12px;
      color: #333;
    }
    .image-box {
      border: 2px solid #1e90ff;
      display: flex;
      flex-direction: column;
    }
    .sensor-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(120px, 1fr));
      grid-auto-rows: minmax(80px, auto);
      gap: 8px;
      overflow: auto;
    }
    .sensor-card {
      background: #ffffff;
      border: 1px solid #ccc;
      border-radius: 4px;
      padding: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    .sensor-card img {
      max-width: 100%;
      max-height: 80px;
      object-fit: contain;
      margin-bottom: 4px;
    }
    .text-box {
      border: 2px solid #708090;
      display: flex;
      flex-direction: column;
    }
    #commentBox {
      flex: 1;
      width: 100%;
      resize: none;
      padding: 6px;
      box-sizing: border-box;
      font-family: monospace;
      font-size: 13px;
    }
    .text-actions {
      margin-top: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }
    .text-actions button {
      padding: 4px 10px;
      border-radius: 3px;
      border: none;
      cursor: pointer;
      background: #32cd32;
      color: #fff;
      font-weight: bold;
    }
    .text-path {
      font-size: 11px;
      color: #555;
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .html-box {
      border: 2px solid #ff69b4;
      display: flex;
      flex-direction: column;
    }
    .html-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .html-header button {
      padding: 4px 8px;
      cursor: pointer;
    }
    #htmlPreview {
      flex: 1;
      width: 100%;
      border: 1px solid #ccc;
      background: #fff;
    }
    .no-data {
      color: #666;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="page">
    <div class="toolbar">
      <label for="logSelect">Log name</label>
      <select id="logSelect"></select>
      <div id="htmlInfo" class="no-data">No HTML selected.</div>
    </div>

    <div class="layout">
      <!-- Left upper: video player -->
      <div class="box video-box">
        <video id="videoPlayer" controls></video>
        <div id="videoInfo" class="video-info no-data"></div>
      </div>

      <!-- Right upper: images for FL/FR/RL/RR(/FC) -->
      <div class="box image-box">
        <div id="sensorGrid" class="sensor-grid"></div>
      </div>

      <!-- Left lower: text comments with Save -->
      <div class="box text-box">
        <textarea id="commentBox"></textarea>
        <div class="text-actions">
          <div id="commentPath" class="text-path no-data">No video selected.</div>
          <button id="saveCommentBtn" style="display:none;">Save</button>
        </div>
      </div>

      <!-- Right lower: HTML preview + open button -->
      <div class="box html-box">
        <div class="html-header">
          <span id="htmlPreviewLabel" class="no-data">No HTML preview.</span>
          <button id="openHtmlBtn" disabled>Open</button>
        </div>
        <iframe id="htmlPreview"></iframe>
      </div>
    </div>
  </div>

  <script>
    const mappings = {
  "1_asdf": {
    "video": "file:///C:/Users/ouymc2/Desktop/dc_viz/db/video/SADHFKJASDF_1_asdf_web.mp4",
    "video_name": "SADHFKJASDF_1_asdf_web.mp4",
    "html_files": [
      "db/html/CCA_9010_1_asdf/CCA_9010_3100099_DEBUG_20250828_163718_0001.html"
    ],
    "html_folder": "CCA_9010_1_asdf",
    "images": [
      "db/html/CCA_9010_1_asdf/FC/fc.png",
      "db/html/CCA_9010_1_asdf/FL/CCA_9010_1_asdf_fl.png",
      "db/html/CCA_9010_1_asdf/FR/CCA_9010_1_asdf_fr.png",
      "db/html/CCA_9010_1_asdf/RL/rl.png",
      "db/html/CCA_9010_1_asdf/RR/rr.png"
    ],
    "comment_path": "db/video/log_txt/SADHFKJASDF_1_asdf_web.txt"
  },
  "2_sdf": {
    "video": "file:///C:/Users/ouymc2/Desktop/dc_viz/db/video/dsfgfsd_2_sdf_web.mp4",
    "video_name": "dsfgfsd_2_sdf_web.mp4",
    "html_files": [
      "db/html/CCA_9010_2_sdf/CCA_9010_3100099_DEBUG_20250828_163733_0002.html"
    ],
    "html_folder": "CCA_9010_2_sdf",
    "images": [
      "db/html/CCA_9010_2_sdf/FC/fc.png",
      "db/html/CCA_9010_2_sdf/FL/CCA_9010_1_asdf_fl.png",
      "db/html/CCA_9010_2_sdf/FR/CCA_9010_1_asdf_fr.png",
      "db/html/CCA_9010_2_sdf/RL/rl.png",
      "db/html/CCA_9010_2_sdf/RR/rr.png"
    ],
    "comment_path": "db/video/log_txt/dsfgfsd_2_sdf_web.txt"
  },
  "3_ert": {
    "video": "file:///C:/Users/ouymc2/Desktop/dc_viz/db/video/dagfjsdhaf_3_ert_web.mp4",
    "video_name": "dagfjsdhaf_3_ert_web.mp4",
    "html_files": [
      "db/html/CCA_9010_3_ert/CCA_9010_3100099_DEBUG_20250828_163748_0003.html"
    ],
    "html_folder": "CCA_9010_3_ert",
    "images": [
      "db/html/CCA_9010_3_ert/FC/fc.png",
      "db/html/CCA_9010_3_ert/FL/CCA_9010_1_asdf_fl.png",
      "db/html/CCA_9010_3_ert/FR/CCA_9010_1_asdf_fr.png",
      "db/html/CCA_9010_3_ert/RL/rl.png",
      "db/html/CCA_9010_3_ert/RR/rr.png"
    ],
    "comment_path": "db/video/log_txt/dagfjsdhaf_3_ert_web.txt"
  },
  "4_sder": {
    "video": "file:///C:/Users/ouymc2/Desktop/dc_viz/db/video/sadfuisadf_4_sder_web.mp4",
    "video_name": "sadfuisadf_4_sder_web.mp4",
    "html_files": [
      "db/html/CCA_9010_4_sder/CCA_9010_3100099_DEBUG_20250828_163803_0004.html"
    ],
    "html_folder": "CCA_9010_4_sder",
    "images": [
      "db/html/CCA_9010_4_sder/FC/fc.png",
      "db/html/CCA_9010_4_sder/FL/CCA_9010_1_asdf_fl.png",
      "db/html/CCA_9010_4_sder/FR/CCA_9010_1_asdf_fr.png",
      "db/html/CCA_9010_4_sder/RL/rl.png",
      "db/html/CCA_9010_4_sder/RR/rr.png"
    ],
    "comment_path": "db/video/log_txt/sadfuisadf_4_sder_web.txt"
  }
};

    let currentKey = null;
    let currentPreviewHtml = null;
    let isCommentDirty = false;

    function populateDropdown() {
      const select = document.getElementById('logSelect');
      const keys = Object.keys(mappings).sort();
      select.innerHTML = '';
      keys.forEach(function(k) {
        const opt = document.createElement('option');
        opt.value = k;
        opt.textContent = mappings[k].html_folder || k;
        select.appendChild(opt);
      });
      select.addEventListener('change', function() {
        updateScenario(select.value);
      });
      if (keys.length > 0) {
        updateScenario(keys[0]);
      }
    }

    function buildSensorGrid(entry) {
      const grid = document.getElementById('sensorGrid');
      grid.innerHTML = '';
      if (!entry || !Array.isArray(entry.images) || entry.images.length === 0) {
        const msg = document.createElement('div');
        msg.className = 'no-data';
        msg.textContent = 'No images for this scenario.';
        grid.appendChild(msg);
        return;
      }

      const sensors = ['FL', 'FR', 'RL', 'RR', 'FC'];
      let used = 0;
      sensors.forEach(function(sensor) {
        const imgPath = entry.images.find(function(p) { return p.indexOf('/' + sensor + '/') !== -1; });
        if (!imgPath) {
          return;
        }
        used += 1;
        const card = document.createElement('div');
        card.className = 'sensor-card';
        const img = document.createElement('img');
        img.src = imgPath;
        img.alt = imgPath.split('/').pop() || sensor;
        const label = document.createElement('div');
        label.textContent = sensor;
        card.appendChild(img);
        card.appendChild(label);
        grid.appendChild(card);
      });

      if (used === 0) {
        const msg = document.createElement('div');
        msg.className = 'no-data';
        msg.textContent = 'No FL/FR/RL/RR/FC images for this log.';
        grid.appendChild(msg);
      }
    }

    function getCommentPath(entry) {
      if (!entry || !entry.comment_path) return null;
      return entry.comment_path;
    }

    async function loadExistingComment(entry) {
      const commentBox = document.getElementById('commentBox');
      const pathLabel = document.getElementById('commentPath');
      const saveBtn = document.getElementById('saveCommentBtn');
      const path = getCommentPath(entry);
      if (!path) {
        commentBox.value = '';
        pathLabel.textContent = 'No video selected.';
        pathLabel.classList.add('no-data');
        saveBtn.style.display = 'none';
        isCommentDirty = false;
        return;
      }

      pathLabel.textContent = path;
      pathLabel.classList.remove('no-data');
      saveBtn.style.display = 'none';
      isCommentDirty = false;

      try {
        const resp = await fetch(path);
        if (!resp.ok) throw new Error('not found');
        const txt = await resp.text();
        commentBox.value = txt;
      } catch (e) {
        commentBox.value = '';
      }
    }

    async function saveComment(entry) {
      const commentBox = document.getElementById('commentBox');
      const saveBtn = document.getElementById('saveCommentBtn');
      const path = getCommentPath(entry);
      if (!path) return;

      const body = commentBox.value || '';

      // Pure-browser save: download a .txt file which you can place under db/video/log_txt/
      const blob = new Blob([body], { type: 'text/plain' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = path.split('/').pop() || 'comment.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(a.href);
      isCommentDirty = false;
      saveBtn.style.display = 'none';
    }

    function updateHtmlPreview(entry, key) {
      const iframe = document.getElementById('htmlPreview');
      const label = document.getElementById('htmlPreviewLabel');
      const openBtn = document.getElementById('openHtmlBtn');
      const htmlInfo = document.getElementById('htmlInfo');

      if (entry && Array.isArray(entry.html_files) && entry.html_files.length > 0) {
        const mainHtml = entry.html_files[0];
        currentPreviewHtml = mainHtml;
        iframe.src = mainHtml;
        label.textContent = mainHtml.split('/').pop() || 'HTML preview';
        label.classList.remove('no-data');
        openBtn.disabled = false;
        if (htmlInfo) {
          htmlInfo.textContent = entry.html_folder || key;
          htmlInfo.classList.remove('no-data');
        }
      } else {
        currentPreviewHtml = null;
        iframe.removeAttribute('src');
        label.textContent = 'No HTML preview.';
        label.classList.add('no-data');
        openBtn.disabled = true;
        if (htmlInfo) {
          htmlInfo.textContent = 'No HTML files mapped for this scenario.';
          htmlInfo.classList.add('no-data');
        }
      }
    }

    function wireGlobalHandlers() {
      const openBtn = document.getElementById('openHtmlBtn');
      openBtn.addEventListener('click', function() {
        if (currentPreviewHtml) {
          window.open(currentPreviewHtml, '_blank');
        }
      });

      const commentBox = document.getElementById('commentBox');
      const saveBtn = document.getElementById('saveCommentBtn');
      commentBox.addEventListener('input', function() {
        isCommentDirty = true;
        saveBtn.style.display = 'inline-block';
      });
      saveBtn.addEventListener('click', function() {
        if (!currentKey) return;
        const entry = mappings[currentKey];
        saveComment(entry);
      });
    }

    function updateScenario(key) {
      currentKey = key;
      const entry = mappings[key];
      const videoPlayer = document.getElementById('videoPlayer');
      const videoInfo = document.getElementById('videoInfo');

      if (entry && entry.video) {
        videoPlayer.src = entry.video;
        videoPlayer.autoplay = true;
        videoPlayer.load();
        videoPlayer.play().catch(function() {});
        videoInfo.textContent = entry.video_name || entry.video;
        videoInfo.classList.remove('no-data');
      } else {
        videoPlayer.removeAttribute('src');
        videoInfo.textContent = 'No video for this scenario.';
        videoInfo.classList.add('no-data');
      }

      buildSensorGrid(entry);
      loadExistingComment(entry);
      updateHtmlPreview(entry, key);
    }

    document.addEventListener('DOMContentLoaded', function() {
      wireGlobalHandlers();
      populateDropdown();
    });
  </script>
</body>
</html>

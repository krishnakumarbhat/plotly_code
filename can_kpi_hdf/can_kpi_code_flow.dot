digraph can_kpi_flow {
    rankdir = LR;
    splines = true;
    nodesep = 0.45;
    ranksep = 0.75;
    labelloc = "t";
    label = "CAN KPI Detailed Function/Data Flow (HDF -> HTML)";
    
    node [shape = box; style = "rounded,filled"; fontname = "Segoe UI"; fontsize = 10;];
    edge [color = "#455a64"; arrowsize = 0.7; fontname = "Segoe UI"; fontsize = 9;];
    
    // Legend
    subgraph cluster_legend {
        label = "Legend";
        color = "#cfd8dc";
        lg_used [label = "Used function";fillcolor = "#e8f5e9";color = "#2e7d32";];
        lg_unused [label = "Unused function";fillcolor = "#ffebee";color = "#c62828";];
        lg_data [label = "Data object";shape = ellipse;fillcolor = "#e3f2fd";color = "#1565c0";];
        lg_io [label = "File / I/O";shape = cylinder;fillcolor = "#fff8e1";color = "#ef6c00";];
    }
    
    start [label = "START (__main__)";shape = diamond;fillcolor = "#ede7f6";color = "#5e35b1";];
    end [label = "END";shape = diamond;fillcolor = "#ede7f6";color = "#5e35b1";];
    
    // Files and key data
    kpi_json [label = "kpi.json";shape = cylinder;fillcolor = "#fff8e1";color = "#ef6c00";];
    in_hdf [label = "input.h5 / INPUT_HDF[*]";shape = cylinder;fillcolor = "#fff8e1";color = "#ef6c00";];
    out_hdf [label = "output.h5 / OUTPUT_HDF[*]";shape = cylinder;fillcolor = "#fff8e1";color = "#ef6c00";];
    parsed_cfg [label = "cfg dict";shape = ellipse;fillcolor = "#e3f2fd";color = "#1565c0";];
    parsed_input [label = "parsed input dict";shape = ellipse;fillcolor = "#e3f2fd";color = "#1565c0";];
    parsed_output [label = "parsed output dict";shape = ellipse;fillcolor = "#e3f2fd";color = "#1565c0";];
    store_obj [label = "CANKpiDataStore";shape = ellipse;fillcolor = "#e3f2fd";color = "#1565c0";];
    match_results [label = "match_results dict";shape = ellipse;fillcolor = "#e3f2fd";color = "#1565c0";];
    sensor_tabs [label = "sensor_tabs OrderedDict";shape = ellipse;fillcolor = "#e3f2fd";color = "#1565c0";];
    html_blob [label = "final HTML string";shape = ellipse;fillcolor = "#e3f2fd";color = "#1565c0";];
    report_html [label = "<stem>.html report";shape = cylinder;fillcolor = "#fff8e1";color = "#ef6c00";];
    index_html [label = "index.html";shape = cylinder;fillcolor = "#fff8e1";color = "#ef6c00";];
    
    subgraph cluster_main {
        label = "Entry + Orchestration (kpi_main.py)";
        color = "#90a4ae";
        
        km_parse_args [label = "kpi_main._parse_args()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        km_resolve [label = "kpi_main._resolve_config_path()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        km_init [label = "KpiMain.__init__()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        km_run [label = "KpiMain.run(config, output_dir)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        km_index [label = "KpiMain._build_index(reports)";fillcolor = "#e8f5e9";color = "#2e7d32";];
    }
    
    subgraph cluster_business {
        label = "Business Layer (c_business_layer/kpi_business.py)";
        color = "#90a4ae";
        
        kb_init [label = "KpiBusiness.__init__()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        kb_run [label = "KpiBusiness.run(kpi_json_path)";fillcolor = "#ffebee";color = "#c62828";];
        kb_run_pair [label = "KpiBusiness.run_pair(input_hdf, output_hdf, title)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        kb_sensor_tab [label = "KpiBusiness._build_sensor_tab()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        kb_match [label = "KpiBusiness._compute_match_pct()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        kb_all_radars [label = "KpiBusiness._build_all_radars_match()";fillcolor = "#ffebee";color = "#c62828";];
        kb_summary [label = "KpiBusiness._build_summary_tables()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        kb_pct [label = "KpiBusiness._pct()";fillcolor = "#e8f5e9";color = "#2e7d32";];
    }
    
    subgraph cluster_persist {
        label = "Persistence Layer (a_persistence_layer)";
        color = "#90a4ae";
        
        jp_parse [label = "KpiJsonParser.parse(path)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        jp_exist [label = "KpiJsonParser._existing_paths()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        
        hp_init [label = "KpiHdfParser.__init__()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hp_parse [label = "KpiHdfParser.parse_file(hdf_path)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hp_scan_grp [label = "KpiHdfParser.build_scan_group_dict()";fillcolor = "#ffebee";color = "#c62828";];
        hp_maxdet [label = "KpiHdfParser._max_det_index()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        
        hr_read_attrs [label = "HdfAttrReader.read_hdf_attrs(path)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hr_read_collect [label = "HdfAttrReader.read_hdf_collect(path)";fillcolor = "#ffebee";color = "#c62828";];
        hr_scan_idx [label = "HdfAttrReader.get_scan_index()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hr_det [label = "HdfAttrReader.extract_detection_signals()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hr_align [label = "HdfAttrReader.extract_alignment_signals()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hr_head [label = "HdfAttrReader.extract_header_signals()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hr_grp [label = "HdfAttrReader._read_group_attrs()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hr_flat [label = "HdfAttrReader._extract_flat()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hr_cls [label = "HdfAttrReader._classify_subgroups()";fillcolor = "#e8f5e9";color = "#2e7d32";];
    }
    
    subgraph cluster_store {
        label = "Data Store Layer (b_data_storage/can_kpi_store.py)";
        color = "#90a4ae";
        
        ds_init [label = "CANKpiDataStore.__init__()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_add [label = "add_parsed_data(label, parsed)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_labels [label = "labels()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_sids [label = "sensor_ids(label)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_sensor [label = "get_sensor(label, sensor_id)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_scan [label = "get_scan_index(label, sensor_id)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_sig [label = "get_detection_signal(label, sensor_id, signal)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_2d [label = "get_detection_2d(label, sensor_id, signal)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_align [label = "get_alignment_signals(label, sensor_id)";fillcolor = "#ffebee";color = "#c62828";];
        ds_hdr [label = "get_header_signals(label, sensor_id)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_all [label = "get_all_signal_names(label, sensor_id)";fillcolor = "#e8f5e9";color = "#2e7d32";];
        ds_sum [label = "summary()";fillcolor = "#ffebee";color = "#c62828";];
        ds_cmp [label = "compare_detection_signal()";fillcolor = "#ffebee";color = "#c62828";];
    }
    
    subgraph cluster_html {
        label = "Presentation Layer (d_presentation_layer/kpi_html_gen.py)";
        color = "#90a4ae";
        
        hg_init [label = "KpiHtmlGen.__init__()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hg_det [label = "detection_scatter()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hg_io [label = "input_output_scatter()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hg_line [label = "match_line_plot()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hg_all [label = "match_all_radars_plot()";fillcolor = "#ffebee";color = "#c62828";];
        hg_table [label = "stats_table()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hg_tabs [label = "build_tabbed_html()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hg_css [label = "_css()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hg_js [label = "_tab_js()";fillcolor = "#e8f5e9";color = "#2e7d32";];
        hg_div [label = "_div(fig)";fillcolor = "#e8f5e9";color = "#2e7d32";];
    }
    
    subgraph cluster_debug {
        label = "Debug Script (spotcheck_match.py)";
        color = "#90a4ae";
        sp_main [label = "spotcheck_match.main()";fillcolor = "#e8f5e9";color = "#2e7d32";];
    }
    
    subgraph cluster_legacy_storage {
        label = "Legacy Storage (b_data_storage/kpi_data_model_storage.py)";
        color = "#b0bec5";
        ls_init [label = "KPI_DataModelStorage.__init__()";fillcolor = "#ffebee";color = "#c62828";];
        ls_initialize [label = "initialize()";fillcolor = "#ffebee";color = "#c62828";];
        ls_initialize_comp [label = "initialize_comp()";fillcolor = "#ffebee";color = "#c62828";];
        ls_init_parent [label = "init_parent()";fillcolor = "#ffebee";color = "#c62828";];
        ls_set_value [label = "set_value()";fillcolor = "#ffebee";color = "#c62828";];
        ls_process [label = "_process_dataset()";fillcolor = "#ffebee";color = "#c62828";];
        ls_clear [label = "clear()";fillcolor = "#ffebee";color = "#c62828";];
        ls_round [label = "round_to_2_decimals()";fillcolor = "#ffebee";color = "#c62828";];
        ls_get_value [label = "get_value()";fillcolor = "#ffebee";color = "#c62828";];
        ls_get_data [label = "get_data()";fillcolor = "#ffebee";color = "#c62828";];
    }
    
    // Primary entry flow
    start -> km_parse_args;
    km_parse_args -> km_resolve [label = "when json path omitted";];
    km_parse_args -> km_init [label = "build app object";];
    km_init -> kb_init;
    km_init -> km_run;
    
    // Object wiring
    kb_init -> hp_init [label = "self._hdf";];
    kb_init -> hg_init [label = "self._html";];
    
    // Config and run loop
    km_run -> jp_parse [label = "read config";];
    jp_parse -> kpi_json;
    jp_parse -> jp_exist [label = "validate INPUT_HDF/OUTPUT_HDF paths";];
    jp_parse -> parsed_cfg;
    
    km_run -> kb_run_pair [label = "for each input/output pair";];
    km_run -> km_index [label = "build index page";];
    km_index -> index_html [label = "write_text()";];
    km_run -> report_html [label = "write_text(result['html'])";];
    report_html -> end;
    index_html -> end;
    
    // Business pair processing (core)
    kb_run_pair -> ds_init [label = "create store";];
    ds_init -> store_obj;
    
    kb_run_pair -> hp_parse [label = "parse input_hdf";];
    in_hdf -> hp_parse;
    hp_parse -> parsed_input;
    
    kb_run_pair -> hp_parse [label = "parse output_hdf";];
    out_hdf -> hp_parse;
    hp_parse -> parsed_output;
    
    kb_run_pair -> ds_add [label = "add input";];
    parsed_input -> ds_add;
    ds_add -> store_obj;
    
    kb_run_pair -> ds_add [label = "add output";];
    parsed_output -> ds_add;
    
    kb_run_pair -> ds_sids [label = "collect all sensors";];
    kb_run_pair -> kb_match [label = "per sensor";];
    kb_match -> match_results;
    
    kb_run_pair -> kb_summary;
    kb_run_pair -> kb_sensor_tab [label = "per sensor";];
    kb_sensor_tab -> sensor_tabs;
    kb_run_pair -> hg_tabs [label = "compose final HTML";];
    hg_tabs -> html_blob;
    html_blob -> report_html;
    
    kb_run_pair -> ds_labels [label = "collect signal list";];
    ds_labels -> ds_sids;
    ds_sids -> ds_all;
    
    // HDF parser internals
    hp_parse -> hr_read_attrs;
    hr_read_attrs -> hr_cls;
    hr_read_attrs -> hr_grp;
    hp_parse -> hr_scan_idx;
    hp_parse -> hr_det;
    hp_parse -> hr_align;
    hp_parse -> hr_head;
    hp_parse -> hp_maxdet;
    hr_align -> hr_flat;
    hr_head -> hr_flat;
    
    // Sensor tab internals
    kb_sensor_tab -> ds_all;
    kb_sensor_tab -> ds_2d;
    kb_sensor_tab -> hg_io;
    kb_sensor_tab -> hg_line [label = "overall match% plot";];
    hg_io -> hg_det;
    hg_io -> hg_div;
    hg_line -> hg_div;
    
    // Match computation internals
    kb_match -> ds_scan;
    kb_match -> ds_hdr;
    kb_match -> ds_sig;
    ds_scan -> ds_sensor;
    ds_hdr -> ds_sensor;
    ds_sig -> ds_sensor;
    
    // Summary internals
    kb_summary -> ds_scan;
    kb_summary -> ds_all;
    kb_summary -> kb_pct;
    kb_summary -> hg_table;
    hg_table -> hg_tabs;
    hg_tabs -> hg_css;
    hg_tabs -> hg_js;
    
    // Unused but present relationships
    kb_run -> jp_parse [style = dashed; color = "#c62828"; label = "legacy path";];
    kb_run -> kb_run_pair [style = dashed; color = "#c62828";];
    kb_all_radars -> hg_all [style = dashed; color = "#c62828";];
    hg_all -> hg_div [style = dashed; color = "#c62828";];
    hp_scan_grp -> hp_parse [style = dashed; color = "#c62828"; label = "not invoked";];
    hr_read_collect -> hr_grp [style = dashed; color = "#c62828"; label = "legacy dataset mode";];
    ds_align -> ds_sensor [style = dashed; color = "#c62828";];
    ds_sum -> ds_sids [style = dashed; color = "#c62828";];
    ds_cmp -> ds_sensor [style = dashed; color = "#c62828";];
    
    // Debug script flow (secondary entry)
    sp_main -> kb_init;
    sp_main -> kb_run_pair;
    sp_main -> kb_match;
    sp_main -> ds_scan;
    sp_main -> ds_hdr;
    sp_main -> ds_sig;
}